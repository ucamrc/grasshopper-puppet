# Shibboleth setup in grasshopper-puppet

## Background Info

* [Shibboleth](https://wiki.shibboleth.net/confluence/display/SHIB2/Home) Single Sign-On

## Pre-requisites

Please ensure that you have read the following documents first:

* [README.md](README.md) - General Grasshopper setup
* [README-ssl.md](README-ssl.md) - SSL (https) setup
  * N.B. Shibboleth support in Grasshopper currently mandates using https
* The Shibboleth section of [Grasshopper's Apache README.md](https://github.com/CUL-DigitalServices/grasshopper/blob/master/etc/apache/README.md)
  * As Grasshopper is a multi-tenant application, its support for Shibboleth is
    not entirely standard

## Puppet Configuration

To enable Shibboleth support in these puppet scripts, include the following in your
`environments/[env name]/hiera/common.json` file:

`"enable_shib": "true",`

You will need to specify the following extra parameters too:

**Shibboleth SP tenant hostname: shibsp_hostname**

This MUST be different from your ordinary tenant hostname(s).

*Dev/QA Hint*: If you are using EC2, you can cheat by specifying your tenant
hostname as ec2-nn-nn-nn-nn.eu-west-1.compute.amazonaws.com , and your
Shibboleth SP hostname using its IP address nn.nn.nn.nn. For example:

`"shibsp_hostname": "nnn.nnn.nnn.nnn",`

However, for certain SPs, you may need to be on a certain sub-domain to obtain
extra Shibboleth attributes (for instance, to obtain CRSid from the University
of Cambridge's Raven IdP). If you are just testing, you can fake this locally
by also adding the appropriate hostname to your /etc/hosts file. For example:

`"shibsp_hostname": "localonly.mysubdomain.cam.ac.uk",`.


**IdP (Identity Provider) settings**

If you do not specify any, the default settings for TestShib will apply.

Here are the settings for the University of Cambridge's Raven IdP:

```
  "ghservice::shibboleth::idp_entityid" : "https://shib.raven.cam.ac.uk/shibboleth",
  "ghservice::shibboleth::idp_metadata_uri" : "https://shib.raven.cam.ac.uk/ucamfederation-idp2-metadata.xml",
  "ghservice::shibboleth::idp_metadata_localfile" : "ucamfederation-idp2-metadata.xml",
```

Please note that the IdP Entity ID specified here must match that configured for each
Grasshopper Tenant App - more on this below.

Finally, you may need to modify `modules/ghservice/files/shibboleth/attribute-map.xml`
in order to expose the right Shibboleth attributes to Grasshopper. The default
configuration should work for Raven.

Optionally, you may want to supply your own key/certificate pair for your SP.
By default, the puppet scripts will do the conventially accepted thing of using shib-keygen
to generate a self-signed X.509 certificate and key into the following locations,
unless you supply the files yourself BEFORE provisioning with puppet:

* `/etc/shibboleth/sp-cert.pem`
* `/etc/shibboleth/sp-key.pem`

The certificate supplied here will affect the SP Metadata autogenerated below.

## Grasshopper Tenant App Configuration

By default, the puppet scripts will automatically configure one Tenant for you,
and you shouldn't need to do anything.

For the general case, you will need to make sure the following parameters are set,
either via the Global Administration UI (`https://admin.hostname/configuration`),
or via the Global Administration REST API (see Swagger API docs at
`https://admin.hostname/docs`):

* `enableShibbolethAuth` = `true`
* `shibIdpEntityId` = same value as you used for `ghservice::shibboleth::idp_entityid` above
* `shibExternalIdAttributes`,`shibMapDisplayname`,`shibMapEmail` need to be set
  appropriately to map Shibboleth attributes to Grasshopper user metadata

## Provision server

You can now provision your server as described in [README.md](README.md).

## Register your SP Metadata with your IdP

Now you need to register your Service Provider (SP) Metadata with your
Identity Provider (IdP):

After you have provisioned your server, download your SP Metadata from the
following URL:

`https://shib-sp.hostname/Shibboleth.sso/Metadata`

Review this Metadata, edit if necessary, and then register that SP Metadata
with your IdP - for instance:

* TestShib - http://testshib.org/register.html
* Raven - https://wiki.cam.ac.uk/raven/SP_registration

